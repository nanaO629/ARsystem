<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR Navi (GLB矢印＋GLB階段 / オフセット対応)</title>

  <!-- A-Frame / AR.js（CDN） -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <script>
    // カメラのヨー（Y軸）のみ追従（鏡像にならないよう +PI は足さない）
    AFRAME.registerComponent('face-camera-yaw', {
      init(){ this.vCam=new THREE.Vector3(); this.vObj=new THREE.Vector3(); },
      tick(){
        const s=this.el.sceneEl; if(!s||!s.camera) return;
        s.camera.getWorldPosition(this.vCam);
        this.el.object3D.getWorldPosition(this.vObj);
        const dx=this.vCam.x-this.vObj.x, dz=this.vCam.z-this.vObj.z;
        const yaw=Math.atan2(dx,dz);
        this.el.object3D.rotation.set(0,yaw,0);
      }
    });

    // GLBの実寸高さを指定値に自動フィット
    AFRAME.registerComponent('fit-model-height', {
      schema:{ height:{type:'number', default:0.6} },
      init(){
        this.el.addEventListener('model-loaded', e=>{
          const obj=e.detail.model;
          const box=new THREE.Box3().setFromObject(obj);
          const size=new THREE.Vector3(); box.getSize(size);
          const h=size.y||1; const s=this.data.height/h;
          this.el.object3D.scale.set(s,s,s);
        });
      }
    });
  </script>
</head>
<body style="margin:0; overflow:hidden;">

  <a-scene id="scene"
           embedded
           renderer="alpha: true; antialias: true"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: true"
           arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false">
    <a-assets timeout="20000" id="assets">
      <a-asset-item id="arrowModel"  src="arrow.glb"></a-asset-item>
      <a-asset-item id="stairsModel" src="stairs.glb"></a-asset-item>
    </a-assets>

    <a-entity camera id="cam"></a-entity>
    <a-entity id="markerLayer" visible="true"></a-entity>
  </a-scene>

  <script>
    /* ==== 矢印の向きテーブル ==== */
    const yawMap = {'直進':0,'下':0,'うしろ':180,'右':-90,'左':90,'右斜め':-45,'左斜め':45};
    const normalize = d => d==='ひだり' ? '左' : d;

    /* ==== 回転オフセット（ここを変えるだけでGLBの前向き補正） ==== */
    const ARROW_YAW_OFFSET = 90;   

    /* ==== ルート定義 ==== */
    const plan = {
      '3':  {1:'右', 2:'うしろ',3:'うしろ', 4:'左',5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '4':  {1:'右', 2:'右', 3:'下', 4:'直進', 5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '5':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'直進', 6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '6':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'ひだり', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '7':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'右',   7:'直進',   8:'左斜め', 9:'左',10:'左',11:'左'},
      '8':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'うしろ', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '9':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'階段', 7:'右',     8:'下',     9:'階段', 10:'左',11:'左'},
      '10': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
             12:'左',13:'左', 14:'左', 15:'下', 16:'右',17:'右'},
      '11': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
             12:'左',13:'左',14:'左',15:'左',16:'左', 17:'下'},
      'gakumu': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
                 12:'下',13:'下', 14:'右',15:'右',16:'右',17:'右'}
    };

    /* ==== 見栄えの基準 ==== */
    // 矢印：高さを0.45mに規格化（大き過ぎ対策）
    const ARROW_BASE_ROT = '0 0 0';
    const ARROW_TARGET_H = 0.45;

    // 階段：高さ0.6mに規格化、看板のように少し上＆手前に
    const STAIRS_BASE_ROT = '0 0 0';
    const STAIRS_TARGET_H = 0.6;
    const STAIRS_GROUP_POS = '0 1.2 0.35';

    const room = new URLSearchParams(location.search).get('room') || '3';

    const scene = document.getElementById('scene');
    scene.addEventListener('loaded', () => {
      const layer = document.getElementById('markerLayer');

      for (let i = 1; i <= 28; i++) {
        const marker = document.createElement('a-marker');
        marker.setAttribute('type','barcode');
        marker.setAttribute('value', String(i));
        marker.setAttribute('id', `marker-${i}`);

        /* === 矢印（arrow.glb） === */
        const arrowWrap = document.createElement('a-entity');
        arrowWrap.setAttribute('id', `arrowWrap${i}`);
        arrowWrap.setAttribute('visible','true');

        const arrowYaw = document.createElement('a-entity'); // ←ここだけ回す
        arrowYaw.setAttribute('id', `arrowYaw${i}`);
        arrowYaw.setAttribute('rotation','0 0 0');

        const arrowModelNode = document.createElement('a-entity');
        arrowModelNode.setAttribute('rotation', ARROW_BASE_ROT);
        arrowModelNode.setAttribute('fit-model-height', `height: ${ARROW_TARGET_H}`);

        const arrowModel = document.createElement('a-entity');
        arrowModel.setAttribute('gltf-model', '#arrowModel');

        arrowModelNode.appendChild(arrowModel);
        arrowYaw.appendChild(arrowModelNode);
        arrowWrap.appendChild(arrowYaw);

        /* === 階段（stairs.glb） === */
        const stairsGroup = document.createElement('a-entity');
        stairsGroup.setAttribute('id', `stairsGroup${i}`);
        stairsGroup.setAttribute('visible','false');
        stairsGroup.setAttribute('face-camera-yaw','');
        stairsGroup.setAttribute('position', STAIRS_GROUP_POS);

        const stairsModelNode = document.createElement('a-entity');
        stairsModelNode.setAttribute('rotation', STAIRS_BASE_ROT);
        stairsModelNode.setAttribute('fit-model-height', `height: ${STAIRS_TARGET_H}`);

        const stairsModel = document.createElement('a-entity');
        stairsModel.setAttribute('gltf-model', '#stairsModel');

        stairsModelNode.appendChild(stairsModel);
        stairsGroup.appendChild(stairsModelNode);

        // ツリーに追加
        marker.appendChild(arrowWrap);
        marker.appendChild(stairsGroup);
        layer.appendChild(marker);

        /* === 指示の適用 === */
        const apply = () => {
          const dirRaw = (plan[room] || {})[i];
          if (!dirRaw) return;
          const dir = normalize(dirRaw);

          if (dir === '階段') {
            arrowWrap.setAttribute('visible','false');
            stairsGroup.setAttribute('visible','true');
          } else {
            stairsGroup.setAttribute('visible','false');
            arrowWrap.setAttribute('visible','true');

            // yaw = 指示角 + オフセット（0..359に正規化）
            const yawBase = yawMap[dir] ?? 0;
            const yaw = ((yawBase + ARROW_YAW_OFFSET) % 360 + 360) % 360;
            arrowYaw.setAttribute('rotation', `0 ${yaw} 0`);
          }
        };

        apply();
        marker.addEventListener('markerFound', apply);
      }
    });
  </script>
</body>
</html>
