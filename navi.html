<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Navi</title>
  <style>
    body{margin:0; overflow:hidden;}
    /* â–¼ è¿½åŠ ï¼šãƒŸãƒ‹åœ°å›³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #btnMap { position:fixed; left:10px; bottom:10px; z-index:9999;
              padding:8px 12px; border-radius:10px; border:1px solid #aaa;
              background:#fff; font-size:14px; }
    #miniMapImg { position:fixed; left:10px; bottom:60px; z-index:9998;
                  width:300px; max-width:70vw; display:none;
                  background:#ffffffcc; backdrop-filter: blur(4px);
                  border:1px solid #aaa; border-radius:12px; padding:8px; }
    #miniMapImg img { display:block; width:100%; height:auto; border-radius:8px; }
    #miniMapImg .hud { margin-top:6px; font-size:12px; color:#333; display:flex; gap:8px; align-items:center; }
    #miniMapImg .pill { padding:2px 6px; border-radius:999px; background:#f3f3f3; border:1px solid #ddd; }
    #miniMapImg .right { margin-left:auto; display:flex; gap:8px; align-items:center; }
  </style>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
</head>
<body>

  <!-- ===== A-Frame / AR.js ã‚·ãƒ¼ãƒ³ ===== -->
  <a-scene
    embedded
    renderer="colorManagement: true;"
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false"
  >
    <!-- 3Dã‚¢ã‚»ãƒƒãƒˆå…ˆèª­ã¿ -->
    <a-assets timeout="15000">
      <a-asset-item id="arrowModel"      src="arrow.glb"></a-asset-item>
      <a-asset-item id="upStairsModel"   src="up stairs.glb"></a-asset-item>
      <a-asset-item id="downStairsModel" src="down stairs.glb"></a-asset-item>
      <a-asset-item id="arrivalModel"    src="arrival.glb"></a-asset-item>
    </a-assets>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- â–¼ è¿½åŠ ï¼šãƒŸãƒ‹åœ°å›³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI -->
  <button id="btnMap">ğŸ—ºï¸ åœ°å›³</button>
  <div id="miniMapImg" aria-live="polite">
    <img id="mapPreview" alt="ç¾åœ¨åœ°ã¤ãç°¡æ˜“åœ°å›³">
    <div class="hud">
      <span class="pill">ç¾åœ¨åœ° â— ä»˜ãåœ°å›³</span>
      <div class="right">
        <label class="pill" style="display:flex;gap:6px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="pinMap"> å¸¸ã«è¡¨ç¤º
        </label>
      </div>
    </div>
  </div>

  <script>
    /********************
     * è¡¨ç¤ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     ********************/
    const ARROW_TARGET_H   = 0.45; // çŸ¢å°ã®è¦‹ã‹ã‘é«˜ã•(m)
    const STAIRS_TARGET_H  = 0.60; // éšæ®µã®è¦‹ã‹ã‘é«˜ã•(m)
    const ARRIVAL_TARGET_H = 0.60; // åˆ°ç€è¡¨ç¤ºã®è¦‹ã‹ã‘é«˜ã•(m)
    const ARROW_YAW_OFFSET = -90;  // çŸ¢å°GLBã®å‰å‘ãè£œæ­£
    const STAIRS_GROUP_POS = { x:0, y:0.8, z:0 };
    const ARRIVAL_GROUP_POS= { x:0, y:0.8, z:0 };

    /********************
     * è‡ªä½œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     ********************/
    // GLBã®å…¨é«˜ã‚’æŒ‡å®šå€¤ã«åˆã‚ã›ã‚‹
    AFRAME.registerComponent('fit-model-height', {
      schema: { target: { type: 'number', default: 0.6 } },
      init() {
        this.el.addEventListener('model-loaded', () => {
          const obj = this.el.getObject3D('mesh');
          if (!obj) return;
          obj.updateMatrixWorld(true);
          const box = new THREE.Box3().setFromObject(obj);
          const size = new THREE.Vector3(); box.getSize(size);
          const h = size.y || 1;
          const s = this.data.target / h;
          this.el.setAttribute('scale', `${s} ${s} ${s}`);
        });
      }
    });

    // çœ‹æ¿ã®ã‚ˆã†ã«Yè»¸ã ã‘ã‚«ãƒ¡ãƒ©ã¸æ­£å¯¾
    AFRAME.registerComponent('face-camera-yaw', {
      tick() {
        const cam = this.el.sceneEl && this.el.sceneEl.camera;
        if (!cam) return;
        const wp = new THREE.Vector3();
        this.el.object3D.getWorldPosition(wp);
        const dx = cam.position.x - wp.x;
        const dz = cam.position.z - wp.z;
        const yaw = Math.atan2(dx, dz) * 180 / Math.PI;
        this.el.setAttribute('rotation', `0 ${yaw} 0`);
      }
    });

    /********************
     * å‘ããƒãƒƒãƒ—ï¼ˆçŸ¢å°ï¼‰
     ********************/
    const yawMap = {
      'ç›´é€²': 0, 'ã†ã—ã‚': 180, 'ä¸‹': 180,
      'å³': -90, 'å·¦': 90,
      'å³æ–œã‚': -45, 'å·¦æ–œã‚': 45,
      // äº’æ›
      'up': 0, 'down': 180, 'back': 180,
      'right': -90, 'left': 90
    };

    /********************
     * çµŒè·¯ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼‰
     * plan[room][markerValue] = æŒ‡ç¤º
     * æŒ‡ç¤ºï¼šã€å³/å·¦/ç›´é€²/ã†ã—ã‚/å³æ–œã‚/å·¦æ–œã‚/éšæ®µä¸Š/éšæ®µä¸‹/åˆ°ç€ã€
     ********************/
    const plan = {
      '3':  {1:'å³', 2:'åˆ°ç€',3:'åˆ°ç€', 4:'å·¦',5:'å·¦',6:'å·¦',7:'å·¦', 8:'å·¦æ–œã‚', 9:'å·¦',10:'å·¦',11:'å·¦',12:'éšæ®µä¸‹',13:'å·¦',14:'å³',15:'éšæ®µä¸‹',16:'å³',17:'å³',18:'å³'},
      '4':  {1:'å³', 2:'å³', 3:'ä¸‹', 4:'åˆ°ç€', 5:'åˆ°ç€',6:'å·¦',7:'å·¦', 8:'å·¦æ–œã‚', 9:'å·¦',10:'å·¦',11:'å·¦',12:'éšæ®µä¸‹',13:'å·¦',14:'å³',15:'éšæ®µä¸‹',16:'å³',17:'å³',18:'å³'},
      '5':  {1:'å³', 2:'å³', 3:'ä¸‹', 4:'å³',   5:'åˆ°ç€', 6:'å·¦',7:'å·¦', 8:'å·¦æ–œã‚', 9:'å·¦',10:'å·¦',11:'å·¦',12:'éšæ®µä¸‹',13:'å·¦',14:'å³',15:'éšæ®µä¸‹',16:'å³',17:'å³',18:'å³'},
      '6':  {1:'å³', 2:'å³', 3:'ä¸‹', 4:'å³',   5:'å³',   6:'ç›´é€²', 7:'ã²ã ã‚Š', 8:'å·¦æ–œã‚', 9:'å·¦',10:'å·¦',11:'å·¦',12:'éšæ®µä¸‹',13:'å·¦',14:'å³',15:'éšæ®µä¸‹',16:'å³',17:'å³',18:'å³'},
      '7':  {1:'å³', 2:'å³', 3:'ä¸‹', 4:'å·¦',   5:'å·¦',   6:'å·¦',   7:'åˆ°ç€',   8:'å·¦æ–œã‚', 9:'å·¦',10:'å·¦',11:'å·¦',12:'éšæ®µä¸‹',13:'å·¦',14:'å³',15:'éšæ®µä¸‹',16:'å³',17:'å³',18:'å³'},
      '8':  {1:'å³', 2:'å³', 3:'ä¸‹', 4:'å³',   5:'å³',   6:'ç›´é€²', 7:'ã†ã—ã‚', 8:'å·¦æ–œã‚', 9:'å·¦',10:'å·¦',11:'å·¦',12:'éšæ®µä¸‹',13:'å·¦',14:'å³',15:'éšæ®µä¸‹',16:'å³',17:'å³',18:'å³'},
      '9':  {1:'å³', 2:'å³', 3:'ä¸‹', 4:'å³', 5:'å³', 6:'éšæ®µä¸Š', 7:'å³', 8:'ä¸‹', 9:'éšæ®µä¸Š', 10:'å·¦',11:'å·¦'},
      '10': {1:'å³',2:'å³',3:'å³',4:'å³', 5:'éšæ®µä¸Š',6:'éšæ®µä¸Š', 7:'å³',8:'å³', 9:'éšæ®µä¸Š', 10:'å·¦',11:'å·¦',
             12:'å·¦',13:'å·¦', 14:'å·¦', 15:'ä¸‹', 16:'å³',17:'å³'},
      '11': {1:'å³',2:'å³',3:'å³',4:'å³', 5:'éšæ®µä¸Š',6:'éšæ®µä¸Š', 7:'å³',8:'å³', 9:'éšæ®µä¸Š', 10:'å·¦',11:'å·¦',
             12:'å·¦',13:'å·¦',14:'å·¦',15:'å·¦',16:'å·¦', 17:'ä¸‹'},
      'gakumu': {1:'å³',2:'å³',3:'å³',4:'å³', 5:'éšæ®µä¸Š',6:'éšæ®µä¸Š', 7:'å³',8:'å³', 9:'éšæ®µä¸Š', 10:'å·¦',11:'å·¦',
                 12:'ä¸‹',13:'ä¸‹', 14:'å³',15:'å³',16:'å³',17:'å³'}
    };

    /********************
     * room ã®æ±ºå®š
     ********************/
    const room = new URLSearchParams(location.search).get('room') || '3';

    /********************
     * ãƒãƒ¼ã‚«ãƒ¼ç”Ÿæˆï¼ˆ1..28ï¼‰
     ********************/
    const scene = document.querySelector('a-scene');
    scene.addEventListener('loaded', () => {
      for (let v = 1; v <= 28; v++) {
        const marker = document.createElement('a-marker');
        marker.setAttribute('type', 'barcode');
        marker.setAttribute('value', String(v));
        marker.setAttribute('id', `m${v}`);

        // --- çŸ¢å°ãƒãƒ¼ãƒ‰ ---
        const arrowWrap = document.createElement('a-entity');
        arrowWrap.setAttribute('id', `arrowWrap-${v}`);
        const arrowYaw = document.createElement('a-entity');
        arrowYaw.setAttribute('id', `arrowYaw-${v}`);
        const arrow = document.createElement('a-entity');
        arrow.setAttribute('gltf-model', '#arrowModel');
        arrow.setAttribute('fit-model-height', `target: ${ARROW_TARGET_H}`);
        arrowYaw.appendChild(arrow);
        arrowWrap.appendChild(arrowYaw);

        // --- éšæ®µãƒãƒ¼ãƒ‰ ---
        const stairsGroup = document.createElement('a-entity');
        stairsGroup.setAttribute('id', `stairsGroup-${v}`);
        stairsGroup.setAttribute('position', `${STAIRS_GROUP_POS.x} ${STAIRS_GROUP_POS.y} ${STAIRS_GROUP_POS.z}`);
        const stairsUp = document.createElement('a-entity');
        stairsUp.setAttribute('id', `stairsUp-${v}`);
        stairsUp.setAttribute('gltf-model', '#upStairsModel');
        stairsUp.setAttribute('fit-model-height', `target: ${STAIRS_TARGET_H}`);
        stairsUp.setAttribute('face-camera-yaw', '');
        const stairsDown = document.createElement('a-entity');
        stairsDown.setAttribute('id', `stairsDown-${v}`);
        stairsDown.setAttribute('gltf-model', '#downStairsModel');
        stairsDown.setAttribute('fit-model-height', `target: ${STAIRS_TARGET_H}`);
        stairsDown.setAttribute('face-camera-yaw', '');
        stairsGroup.appendChild(stairsUp);
        stairsGroup.appendChild(stairsDown);

        // --- åˆ°ç€ãƒãƒ¼ãƒ‰ ---
        const arrivalGroup = document.createElement('a-entity');
        arrivalGroup.setAttribute('id', `arrivalGroup-${v}`);
        arrivalGroup.setAttribute('position', `${ARRIVAL_GROUP_POS.x} ${ARRIVAL_GROUP_POS.y} ${ARRIVAL_GROUP_POS.z}`);
        arrivalGroup.setAttribute('face-camera-yaw', '');
        const arrival = document.createElement('a-entity');
        arrival.setAttribute('id', `arrival-${v}`);
        arrival.setAttribute('gltf-model', '#arrivalModel');
        arrival.setAttribute('fit-model-height', `target: ${ARRIVAL_TARGET_H}`);
        arrivalGroup.appendChild(arrival);

        marker.appendChild(arrowWrap);
        marker.appendChild(stairsGroup);
        marker.appendChild(arrivalGroup);
        scene.appendChild(marker);

        // æ¤œå‡ºã‚¤ãƒ™ãƒ³ãƒˆ
        marker.addEventListener('markerFound', () => {
          apply(v);
          // â–¼ è¿½åŠ ï¼šè©²å½“ãƒãƒ¼ã‚«ãƒ¼ã®åœ°å›³ç”»åƒã‚’è¡¨ç¤º
          showMapFor(v);
        });
      }
      // åˆæœŸåæ˜ 
      apply();
      attachMapHandlers(); // å¿µã®ãŸã‚ï¼ˆå¾Œè¿°ã®é–¢æ•°ã§å®‰å…¨ã«ã‚¢ã‚¿ãƒƒãƒï¼‰
    });

    /********************
     * è¡¨ç¤ºé©ç”¨
     ********************/
    function apply(foundValue) {
      const table = plan[room] || {};
      const loopFrom = (foundValue ? foundValue : 1);
      const loopTo   = (foundValue ? foundValue : 28);

      for (let v = loopFrom; v <= loopTo; v++) {
        const dir = table[v];

        const arrowWrap   = document.getElementById(`arrowWrap-${v}`);
        const arrowYaw    = document.getElementById(`arrowYaw-${v}`);
        const stairsGroup = document.getElementById(`stairsGroup-${v}`);
        const stairsUp    = document.getElementById(`stairsUp-${v}`);
        const stairsDown  = document.getElementById(`stairsDown-${v}`);
        const arrivalGroup= document.getElementById(`arrivalGroup-${v}`);

        // ã„ã£ãŸã‚“å…¨éƒ¨éè¡¨ç¤º
        if (arrowWrap)    arrowWrap.setAttribute('visible', false);
        if (stairsGroup)  stairsGroup.setAttribute('visible', false);
        if (stairsUp)     stairsUp.setAttribute('visible', false);
        if (stairsDown)   stairsDown.setAttribute('visible', false);
        if (arrivalGroup) arrivalGroup.setAttribute('visible', false);

        if (!dir) continue;

        // éšæ®µï¼ˆä¸Š/ä¸‹ï¼‰
        if (dir === 'éšæ®µ' || dir === 'éšæ®µä¸Š' || dir === 'éšæ®µä¸‹') {
          stairsGroup.setAttribute('visible', true);
          if (dir === 'éšæ®µä¸‹') stairsDown.setAttribute('visible', true);
          else stairsUp.setAttribute('visible', true); // 'éšæ®µ' ã¯ä¸Šã‚Šæ‰±ã„
          continue;
        }

        // åˆ°ç€
        if (dir === 'åˆ°ç€') {
          arrivalGroup.setAttribute('visible', true);
          continue;
        }

        // çŸ¢å°ï¼ˆå‘ãï¼‰
        const baseYaw = yawMap[dir];
        if (typeof baseYaw === 'number') {
          const yaw = ((baseYaw + ARROW_YAW_OFFSET) % 360 + 360) % 360;
          arrowWrap.setAttribute('visible', true);
          arrowYaw.setAttribute('rotation', `0 ${yaw} 0`);
        }
      }
    }

    /************************************************************
     * â–¼â–¼ ã“ã“ã‹ã‚‰è¿½åŠ ï¼šãƒãƒ¼ã‚«ãƒ¼ã”ã¨ã®ã€Œåœ°å›³ï¼‹ç¾åœ¨åœ°ç”»åƒã€ã‚’è¡¨ç¤º â–¼â–¼
     ************************************************************/
    // 1) ç”»åƒå¯¾å¿œè¡¨ï¼ˆä¾‹ï¼‰
    // - ç”»åƒã¯ã€Œåœ°å›³ï¼‹ç¾åœ¨åœ°ï¼ˆâ—ï¼‰ã€ãŒæã‹ã‚ŒãŸé™æ­¢ç”»ã‚’ç”¨æ„
    // - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ value(1..28) å¯¾å¿œ
    // - room åˆ¥ã«å·®ã—æ›¿ãˆãŸã„å ´åˆã¯ overrides ã«è¿½è¨˜ï¼ˆ?room=10 ãªã©ï¼‰
    const MAP_IMAGES = {
      default: {
        1:'map1.png',
        2:'maps/default/value_2.png',
        3:'maps/default/value_3.png',
        4:'maps/default/value_4.png',
        5:'maps/default/value_5.png',
        6:'maps/default/value_6.png',
        7:'maps/default/value_7.png',
        8:'maps/default/value_8.png',
        9:'maps/default/value_9.png',
        10:'maps/default/value_10.png',
        11:'maps/default/value_11.png',
        12:'maps/default/value_12.png',
        13:'maps/default/value_13.png',
        14:'maps/default/value_14.png',
        15:'maps/default/value_15.png',
        16:'maps/default/value_16.png',
        17:'maps/default/value_17.png',
        18:'maps/default/value_18.png',
        19:'maps/default/value_19.png',
        20:'maps/default/value_20.png',
        21:'maps/default/value_21.png',
        22:'maps/default/value_22.png',
        23:'maps/default/value_23.png',
        24:'maps/default/value_24.png',
        25:'maps/default/value_25.png',
        26:'maps/default/value_26.png',
        27:'maps/default/value_27.png',
        28:'maps/default/value_28.png'
      },
      overrides: {
        // ä¾‹ï¼šroom=10 ã§ value=6,7 ã‚’å°‚ç”¨å·®ã—æ›¿ãˆ
        '10': {
          6:'maps/room10/value_6.png',
          7:'maps/room10/value_7.png'
        },
        // '11': { 12:'maps/room11/value_12.png' },
        // 'gakumu': { 5:'maps/gakumu/value_5.png' }
      }
    };

    // 2) ãƒˆã‚°ãƒ«UIåˆ¶å¾¡
    const btnMap   = document.getElementById('btnMap');
    const boxMap   = document.getElementById('miniMapImg');
    const imgMap   = document.getElementById('mapPreview');
    const pinMapEl = document.getElementById('pinMap');
    let mapVisible = false;
    btnMap.addEventListener('click', () => {
      mapVisible = !mapVisible;
      boxMap.style.display = mapVisible ? 'block' : 'none';
    });

    // 3) ç”»åƒæ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
    function pickMapImage(value){
      const roomParam = (new URLSearchParams(location.search).get('room') || '').toString();
      const over = (MAP_IMAGES.overrides && MAP_IMAGES.overrides[roomParam]) || null;
      if (over && over[value]) return over[value];
      return MAP_IMAGES.default[value] || null;
    }

    // 4) æ¤œå‡ºæ™‚ã®è‡ªå‹•è¡¨ç¤ºï¼ˆãƒ”ãƒ³ç•™ã‚OFFãªã‚‰4ç§’ã§è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºï¼‰
    let autoHideTimer = null;
    function showMapFor(value){
      const src = pickMapImage(value);
      if (!src) return;
      imgMap.src = src;
      boxMap.style.display = 'block';
      mapVisible = true;
      if (!pinMapEl.checked) {
        if (autoHideTimer) clearTimeout(autoHideTimer);
        autoHideTimer = setTimeout(() => {
          boxMap.style.display = 'none';
          mapVisible = false;
        }, 4000);
      }
    }

    // 5) å¿µã®ãŸã‚ã®ã‚¢ã‚¿ãƒƒãƒï¼ˆsceneç”Ÿæˆå¾Œã«ã‚‚å‘¼ã¶ï¼‰
    function attachMapHandlers(){
      for (let v=1; v<=28; v++){
        const m = document.getElementById('m'+v);
        if (!m) continue;
        // ã™ã§ã« addEventListener ã—ã¦ã„ã‚‹ãŒã€äºŒé‡ç™»éŒ²ã•ã‚Œã¦ã‚‚å•é¡Œãªã„å‡¦ç†ã«ã—ã¦ã‚ã‚‹
        m.addEventListener('markerFound', () => showMapFor(v));
      }
    }
    if (document.readyState === 'complete') attachMapHandlers();
    else window.addEventListener('load', attachMapHandlers);
  </script>
</body>
</html>
