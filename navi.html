<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR Navi (GLB矢印版)</title>

  <!-- A-Frame / AR.js（CDN） -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <script>
    // 階段ピクトを“正面”に見せる：カメラのヨー（Y軸）だけ合わせる
    AFRAME.registerComponent('face-camera-yaw', {
      init(){ this.vCam=new THREE.Vector3(); this.vObj=new THREE.Vector3(); },
      tick(){
        const s=this.el.sceneEl; if(!s||!s.camera) return;
        s.camera.getWorldPosition(this.vCam);
        this.el.object3D.getWorldPosition(this.vObj);
        const dx=this.vCam.x-this.vObj.x, dz=this.vCam.z-this.vObj.z;
        const yaw=Math.atan2(dx,dz); // +Math.PI は入れない（鏡像防止）
        this.el.object3D.rotation.set(0,yaw,0);
      }
    });
  </script>
</head>
<body style="margin:0; overflow:hidden;">

  <a-scene id="scene"
           embedded
           renderer="alpha: true; antialias: true"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: true"
           arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false">
    <!-- アセット（GLB矢印 / 階段画像） -->
    <a-assets timeout="20000" id="assets">
      <a-asset-item id="arrowModel" src="arrow.glb"></a-asset-item>
      <img id="stairsImgAsset" src="stairs.png" crossorigin="anonymous">
    </a-assets>

    <a-entity camera id="cam"></a-entity>

    <!-- マーカー用の入れ物（ここに全部動的生成） -->
    <a-entity id="markerLayer" visible="true"></a-entity>
  </a-scene>

  <script>
    /* ======= 矢印の向きテーブル（従来どおり） ======= */
    const yawMap = {'直進':0,'下':0,'うしろ':180,'右':-90,'左':90,'右斜め':-45,'左斜め':45};
    const normalize = d => d==='ひだり' ? '左' : d;

    /* ======= 目的地ごとの指示（そのまま） ======= */
    const plan = {
      '3':  {1:'右', 2:'うしろ',3:'うしろ', 4:'左',5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '4':  {1:'右', 2:'右', 3:'下', 4:'直進', 5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '5':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'直進', 6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '6':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'ひだり', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '7':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'右',   7:'直進',   8:'左斜め', 9:'左',10:'左',11:'左'},
      '8':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'うしろ', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '9':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'階段', 7:'右',     8:'下',     9:'階段', 10:'左',11:'左'},
      '10': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
             12:'左',13:'左', 14:'左', 15:'下', 16:'右',17:'右'},
      '11': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
             12:'左',13:'左',14:'左',15:'左',16:'左', 17:'下'},
      'gakumu': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
                 12:'下',13:'下', 14:'右',15:'右',16:'右',17:'右'}
    };

    /* ======= GLBモデルの基準回転/スケール =======
       - モデルの“前方”が A-Frame の -Z を向くように合わせます。
       - もし向きが合わない場合は MODEL_BASE_ROT を調整してください。
         例: '0 180 0' / '-90 0 0' / '0 0 0' など。 */
    const MODEL_BASE_ROT = '-90 0 0';   // ←まずはこれで。ズレたらここを変える
    const MODEL_SCALE    = '0.7 0.7 0.7';

    const room = new URLSearchParams(location.search).get('room') || '3';

    const scene = document.getElementById('scene');
    scene.addEventListener('loaded', () => {
      const layer = document.getElementById('markerLayer');
      for (let i = 1; i <= 28; i++) {
        const marker = document.createElement('a-marker');
        marker.setAttribute('type','barcode');
        marker.setAttribute('value', String(i));
        marker.setAttribute('id', `marker-${i}`);

        // ===== 矢印（GLB） =====
        const wrap = document.createElement('a-entity');
        wrap.setAttribute('id', `arrowWrap${i}`);
        wrap.setAttribute('visible','true');

        // ヨー回転ノード（ここだけ回す）
        const yawNode = document.createElement('a-entity');
        yawNode.setAttribute('id', `arrowYaw${i}`);
        yawNode.setAttribute('rotation','0 0 0');

        // モデル本体（基準回転＆スケール）
        const model = document.createElement('a-entity');
        model.setAttribute('gltf-model', '#arrowModel');
        model.setAttribute('rotation', MODEL_BASE_ROT);
        model.setAttribute('scale', MODEL_SCALE);
        model.setAttribute('position', '0 0 0');  // 必要なら 0 0.5 0 などに調整

        yawNode.appendChild(model);
        wrap.appendChild(yawNode);

        // ===== 階段グループ（画像＋文字のフォールバック） =====
        const stairsGroup = document.createElement('a-entity');
        stairsGroup.setAttribute('id', `stairsGroup${i}`);
        stairsGroup.setAttribute('visible','false');
        stairsGroup.setAttribute('face-camera-yaw','');
        stairsGroup.setAttribute('position','0 1.2 0.35'); // 少し上＆手前
        stairsGroup.setAttribute('scale','2.2 2.2 2.2');

        const stairsImg = document.createElement('a-plane');
        stairsImg.setAttribute('id', `stairsImg${i}`);
        stairsImg.setAttribute('width','0.7');
        stairsImg.setAttribute('height','0.7');
        stairsImg.setAttribute('material','shader: flat; src: #stairsImgAsset; transparent: true; side: double; alphaTest: 0.01;');
        stairsImg.setAttribute('visible','true');

        const stairsText = document.createElement('a-entity');
        stairsText.setAttribute('id', `stairsText${i}`);
        stairsText.setAttribute('position','0 0 0.001');
        stairsText.setAttribute('visible','false');
        stairsText.setAttribute('text',{value:'階段へ',align:'center',color:'red',width:3.0,baseline:'center',wrapCount:6});

        stairsGroup.appendChild(stairsImg);
        stairsGroup.appendChild(stairsText);

        // ツリーへ
        marker.appendChild(wrap);
        marker.appendChild(stairsGroup);
        layer.appendChild(marker);

        // ===== 指示を反映 =====
        const apply = () => {
          const dirRaw = (plan[room] || {})[i];
          if (!dirRaw) return;
          const dir = normalize(dirRaw);

          if (dir === '階段') {
            wrap.setAttribute('visible','false');
            stairsGroup.setAttribute('visible','true');
          } else {
            stairsGroup.setAttribute('visible','false');
            wrap.setAttribute('visible','true');
            const yaw = yawMap[dir] ?? 0;
            // GLBは“前を -Z とみなす”。モデルの基準回転は MODEL_BASE_ROT で調整済み。
            yawNode.setAttribute('rotation', `0 ${yaw} 0`);
          }
        };

        apply();
        marker.addEventListener('markerFound', apply);
      }
    });
  </script>
</body>
</html>
