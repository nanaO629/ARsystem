<!-- （headやA-Frame読み込みは今のままでOK） -->

<script>
  // 画像や文字が必ずカメラに正対する（ビルボード）
  AFRAME.registerComponent('billboard', {
    tick: function () {
      const cam = this.el.sceneEl && this.el.sceneEl.camera;
      if (cam) this.el.object3D.quaternion.copy(cam.quaternion);
    }
  });
</script>

<a-scene id="scene" embedded
         arjs="detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false;">
  <!-- ここで階段ピクトをプリロード。stairs.png を同じフォルダに置く -->
  <a-assets timeout="20000" id="assets">
    <img id="stairsImgAsset" src="stairs.png" crossorigin="anonymous">
  </a-assets>

  <a-entity camera id="cam"></a-entity>
</a-scene>

<script>
  // 向き→ヨー角（X=-90で寝かせ、Yだけ回す）
  const yawMap = {'直進':0,'下':0,'うしろ':180,'右':-90,'左':90,'右斜め':-45,'左斜め':45};
  const normalize = d => d==='ひだり'?'左':d;

  // ★ここはあなたの既存planをそのまま使ってOK（3〜11, 学務課入り）
  const plan = { /* ←前回渡した plan をそのまま貼る */ };

  const room = new URLSearchParams(location.search).get('room') || '3';
  const scene = document.querySelector('#scene');

  // 画像アセットのロード完了を待つフラグ
  let stairsReady = false;
  const assets = document.getElementById('assets');
  assets.addEventListener('loaded', () => { stairsReady = true; });

  scene.addEventListener('loaded', () => {
    for (let i = 1; i <= 28; i++) {
      // マーカー
      const marker = document.createElement('a-marker');
      marker.setAttribute('type','barcode');
      marker.setAttribute('value', String(i));
      marker.setAttribute('id', `marker-${i}`);

      // 先輩方式の矢印
      const wrap = document.createElement('a-entity');
      wrap.setAttribute('id', `arrowWrap${i}`);
      wrap.setAttribute('visible','true');

      const yawNode = document.createElement('a-entity');
      yawNode.setAttribute('id', `arrowYaw${i}`);
      yawNode.setAttribute('rotation','-90 0 0'); // 寝かせ固定

      const cone = document.createElement('a-cone');
      cone.setAttribute('position','0 0.6 0');
      cone.setAttribute('radius-bottom','0.4');
      cone.setAttribute('radius-top','0');
      cone.setAttribute('height','1.2');
      cone.setAttribute('color','green');

      const cyl = document.createElement('a-cylinder');
      cyl.setAttribute('position','0 0 0');
      cyl.setAttribute('radius','0.12');
      cyl.setAttribute('height','1.2');
      cyl.setAttribute('color','green');

      yawNode.appendChild(cone);
      yawNode.appendChild(cyl);
      wrap.appendChild(yawNode);

      /* ===== 階段表示グループ（画像＋テキストの両方を用意） ===== */
      const stairsGroup = document.createElement('a-entity');
      stairsGroup.setAttribute('id', `stairsGroup${i}`);
      stairsGroup.setAttribute('visible', 'false');
      stairsGroup.setAttribute('billboard', '');               // 常にカメラ向き
      stairsGroup.setAttribute('position', '0 1.05 0.28');     // マーカー面の少し手前(+Z)＆少し上
      stairsGroup.setAttribute('scale', '1.8 1.8 1.8');

      // 画像（PNG推奨：透明背景OK）
      const stairsImg = document.createElement('a-plane');
      stairsImg.setAttribute('id', `stairsImg${i}`);
      stairsImg.setAttribute('width', '0.7');                  // ここで見た目サイズを調整
      stairsImg.setAttribute('height', '0.7');
      stairsImg.setAttribute('material', 'src: #stairsImgAsset; transparent: true; side: double; alphaTest: 0.01;');
      // ※ a-image でも可だが、a-plane+material のほうが透明PNGで安定

      // 画像が読めない時のフォールバック文字
      const stairsText = document.createElement('a-entity');
      stairsText.setAttribute('id', `stairsText${i}`);
      stairsText.setAttribute('position', '0 0 0.001');        // 画像のほんの手前へ
      stairsText.setAttribute('visible', 'false');
      stairsText.setAttribute('text', {
        value: '階段へ',
        align: 'center',
        color: 'red',
        width: 2.6,
        baseline: 'center',
        wrapCount: 6
      });

      stairsGroup.appendChild(stairsImg);
      stairsGroup.appendChild(stairsText);

      // ツリー構築
      marker.appendChild(wrap);
      marker.appendChild(stairsGroup);
      scene.appendChild(marker);

      // 適用関数（初回＆markerFound時に呼ぶ）
      const apply = () => {
        const dirRaw = (plan[room] || {})[i];
        if (!dirRaw) return; // 指定なしスキップ
        const dir = normalize(dirRaw);

        if (dir === '階段') {
          // 矢印を隠し、階段グループを表示
          wrap.setAttribute('visible','false');
          stairsGroup.setAttribute('visible','true');

          // アセットが読み込み済みなら画像を出す、未ロードなら文字を出す
          if (stairsReady) {
            stairsImg.setAttribute('visible','true');
            stairsText.setAttribute('visible','false');
          } else {
            stairsImg.setAttribute('visible','false');
            stairsText.setAttribute('visible','true');
          }
        } else {
          // 通常矢印
          stairsGroup.setAttribute('visible','false');
          wrap.setAttribute('visible','true');
          const yaw = yawMap[dir] ?? 0;
          yawNode.setAttribute('rotation', `-90 ${yaw} 0`);
        }
      };

      apply();
      marker.addEventListener('markerFound', apply);
    }
  });
</script>
