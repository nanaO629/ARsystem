<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Navi</title>
  <style>
    body{margin:0; overflow:hidden;}

    /* ▼ 右下：距離HUD */
    #hudMsg {
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 9999;
      background: #111c;
      color: #fff;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      max-width: min(60vw, 320px);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: none;
      word-break: break-word;
    }

    /* ▼ 中央下：階段/到着HUD（大きめ・画面固定） */
    #hudAction{
      position: fixed;
      left: 50%;
      bottom: 110px;
      transform: translateX(-50%);
      z-index: 10000;

      background: rgba(0,0,0,0.88);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.65);
      border-radius: 18px;

      padding: 14px 18px;
      font-size: 24px;
      font-weight: 900;
      line-height: 1.2;
      text-align: center;
      min-width: 240px;

      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      text-shadow: 0 2px 6px rgba(0,0,0,0.95);

      display: none;
      user-select: none;
      word-break: break-word;
    }
  </style>

  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
</head>
<body>
  <a-scene
    embedded
    renderer="colorManagement: true;"
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false"
  >
    <a-assets timeout="15000">
      <a-asset-item id="arrowModel" src="arrow.glb"></a-asset-item>
    </a-assets>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="hudMsg" aria-live="polite"></div>
  <div id="hudAction" aria-live="polite"></div>

  <script>
    /********************
     * 定数
     ********************/
    const MAX_MARKER = 58;

    /********************
     * 表示パラメータ
     ********************/
    // ★GLB矢印：少し小さく
    const ARROW_TARGET_H   = 0.35; // ← 0.45 から小さめに
    const ARROW_YAW_OFFSET = -90;  // GLB矢印の前向き補正

    // ★直進（cone/cylinder）色：arrow.glb に近い青
    const FORWARD_COLOR = '#1050f0';

    // 直進（プリミティブ矢印）を見やすい位置に
    const FORWARD_POS = { x: 0.00, y: 0.25, z: 0 };

    // 壁マーカー向け：GLB矢印を「壁から浮かせる」
    const POS_MAP = {
      forward: { x:  0.00, y: 0.00, z: 0.0 },
      back:    { x:  0.00, y: 0.00, z: 0 },
      right:   { x:  0.35, y: 0.00, z: 0 },
      left:    { x: -0.35, y: 0.00, z: 0 },
      right45: { x:  0.25, y: 0.00, z: 0 },
      left45:  { x: -0.25, y: 0.00, z: 0 }
    };
    const POS_DEFAULT = { x: 0.00, y: 0.00, z: 0 };

    /********************
     * 自作コンポーネント
     ********************/
    // GLBの全高を指定値に合わせる
    AFRAME.registerComponent('fit-model-height', {
      schema: { target: { type: 'number', default: 0.6 } },
      init() {
        this.el.addEventListener('model-loaded', () => {
          const obj = this.el.getObject3D('mesh');
          if (!obj) return;
          obj.updateMatrixWorld(true);
          const box = new THREE.Box3().setFromObject(obj);
          const size = new THREE.Vector3(); box.getSize(size);
          const h = size.y || 1;
          const s = this.data.target / h;
          this.el.setAttribute('scale', `${s} ${s} ${s}`);
        });
      }
    });

    // Yawだけカメラへ正対（直進プリミティブ用）
    AFRAME.registerComponent('face-camera-yaw', {
      schema: { offset: { type: 'number', default: 0 } },
      tick() {
        const cam = this.el.sceneEl && this.el.sceneEl.camera;
        if (!cam) return;

        const pos = new THREE.Vector3();
        this.el.object3D.getWorldPosition(pos);

        const dx = cam.position.x - pos.x;
        const dz = cam.position.z - pos.z;

        const yaw = Math.atan2(dx, dz) * 180 / Math.PI + this.data.offset;
        this.el.setAttribute('rotation', `0 ${yaw} 0`);
      }
    });

    /********************
     * 方向の正規化 + 矢印角度（GLB用）
     ********************/
    const CANON = {
      '直進':'forward', 'up':'forward',
      'うしろ':'back', '下':'back', 'down':'back', 'back':'back',
      '右':'right', 'right':'right',
      '左':'left',  'left':'left',
      '右斜め':'right45',
      '左斜め':'left45'
    };
    function normDir(d){ return CANON[d] || d; }

    const yawMap = {
      forward: 0,
      back:    180,
      right:   90,
      left:   -90,
      right45: 45,
      left45: -45
    };

    /********************
     * 範囲展開ヘルパー + ビルダー
     ********************/
    function expandKeys(keys) {
      if (Array.isArray(keys)) return keys.flatMap(k => expandKeys(k));
      if (typeof keys === 'number') return [keys];
      return String(keys).split(',').flatMap(part => {
        const s = part.trim();
        if (/^\d+-\d+$/.test(s)) {
          const [a,b] = s.split('-').map(Number);
          const lo = Math.min(a,b), hi = Math.max(a,b);
          return Array.from({length: hi-lo+1}, (_,i) => lo+i);
        }
        return [Number(s)];
      });
    }

    function buildPlan(spec) {
      const out = {};
      for (const [room, entries] of Object.entries(spec)) {
        const table = out[room] = {};
        for (const [keys, dir] of entries) {
          for (const v of expandKeys(keys)) table[v] = dir;
        }
      }
      return out;
    }

    /********************
     * ルート定義（既存）
     ********************/
    const plan = buildPlan({
      '3': [['1,3,6,,10,11,27-30,,37,41,46,51-53,56,35,36,54,12','右'],['5,14-17,19-21,23-26,33,38,43,45,48,49','左'],['22,39,40,47,55,8,12','直進'],
      ['2,7,4,9,31,32','階段上'],['42,44','階段下'],[13,'到着'],['18,34,50','左斜め']
        
      ],
      '4': [['1,3,6,10,11,24-30,37,35-38,41,51-53,56,12','右'],['5,15-17,19-21,33,43,45,48,49,54','左'],['8,14,22,39,40,46,47,13','直進'],['2,4,7,9,31,32,55','階段上'],
      ['42,44','階段下'],[23,'到着'],['18,34,50','左斜め']
       
      ],
      '5': [['1,3,6,10,11,23,25-30,37,35-38,41,51-53,56,12','右'],['5,15-17,19-21,33,43,45,48,49,54','左'],['8,14,22,39,40,46,47,13','直進'],['2,4,7,9,31,32,55','階段上'],
      ['42,44','階段下'],[24,'到着'],['18,34,50','左斜め']
       
      ],
      '6': [['1,3,6,10,11,24,26-30,37,35-38,41,51-53,56,12','右'],['5,15-17,19-21,23,24,33,43,45,48,49,54','左'],['8,14,22,39,40,46,47,13','直進'],['2,4,7,9,31,32,55','階段上'],
      ['42,44','階段下'],[25,'到着'],['18,34,50','左斜め']
       
      ],
      '7': [['1,3,6,10,11,27-30,37,35-38,41,51-53,56,12','右'],['5,15-17,19-21,33,43,45,48,49,54,23-25','左'],['8,14,22,39,40,46,47,13','直進'],['2,4,7,9,31,32,55','階段上'],
      ['42,44','階段下'],[26,'到着'],['18,34,50','左斜め']
      
      ],
      '8': [['1,3,6,10,11,27-30,37,35-38,41,51-53,56',12,'右'],['5,15-17,19-21,33,43,45,48,49,54,23-25','左'],['8,14,22,39,40,46,47,26,13','直進'],['2,4,7,9,31,32,55','階段上'],
      ['42,44','階段下'],[17,'到着'],['18,34,50','左斜め']
      
      ],
      '9': [['1,3,6,,10,11,14,26,27-30,35-38,46-48,51-53,56,12','右'],['5,17,23,19-21,33,42-45,54','左'],['8,24,25,22,39,40,41,13','直進'],['2,4,7,9,15,16,31,32,55','階段上'],
      [49,'到着'],['18,34,50','左斜め']
       
      ],
      '10': [['1,3,6,,10,11,14,26,27-30,35-38,46-48,51-53,56,46,12','右'],['5,17,23,19-21,33,43-45,54,48','左'],['8,24,25,22,39,40,49,42,13','直進'],['2,4,7,9,15,16,31,32,55','階段上'],
      [47,'到着'],['18,34,50','左斜め']
       
      ],
      '11': [['1,3,6,,10,11,14,26,27-30,35-38,46-48,51-53,56,12','右'],['5,17,23,19-21,33,42-45,54,','左'],['8,24,25,22,39,40,49,13','直進'],['2,4,7,9,15,16,31,32,55','階段上'],
      [41,'到着'],['18,34,50','左斜め']
      
      ],
      'free': [['1,3,6,7,10,11','右']
       
      ],
      'gakumu': [['1,3,6,,10,11,14,26,27-30,35-38,41-44,51-53,56,12','右'],['5,17,23,19-21,33,47-49,54','左'],['8,24,25,22,39,40,45,49,13','直進'],['2,4,7,9,15,16,31,32,55','階段上'],
      [46,'到着'],['18,34,50','左斜め']
      ],

      '1': [['1,3,6,10,11,14,15,26-30,31-34,36,37,41-43,46,51,52,53,54,56,12','右'],['5,13,17,23-24,19-21,38-40,45,47-49','左'],
    ['12,25,55,22,13','直進'],['2,4,9,7,','階段上'],['16,44','階段下'],[35,'到着'],['18,50','左斜め']],

     '2': [['1,3,6,10,11,14,15,26-30,31-34,37,41-43,46,51,52,53,56,54,12','右'],['5,13,17,23-24,19-21,38-40,45,47-49,35','左'],
    ['12,25,55,22,13','直進'],['2,4,9,7,','階段上'],['16,44','階段下'],[36,'到着'],['18,50','左斜め']], 

    '12': [['1,23-26,27-30,37,38,35,36,41,51,46,52,53,54','右'],['4,10,11,12,13,14-17,19-21,33,45,48','左'],['3,6,22,39,40,47,46','直進'],
    ['2,31,32','階段上'],['8,7,42,44','階段下'],[5,'到着'],['9,18,34,50','左斜め']], 

    '13': [['1,23-26,27-30,37,38,35,36,41,51,46,52,53,54','右'],['4,10,11,12,13,14-17,19-21,33,45,48','左'],['3,5,22,39,40,47,46','直進'],
    ['2,31,32','階段上'],['8,7,42,44','階段下'],[6,'到着'],['9,18,34,50','左斜め']],

      'exp1': [['1,3,6,7,10,11','右']],
       'exp2': [['1,3,6,7,10,11','右']], 
       'exp4': [['1,3,6,7,10,11','右']],
      'arch': [['1,3,6,7,10,11','右']], 

      'iotlab': [['1,3,6,10,11,14,26-30,41-45,50,35,36','右'],['5,13,17,19,21,23,33,38,46-49,52,55','左'],
      ['12,22,24,25,39,40,51,53','直進'],['2,4,7,9,15,16,31,32','階段上'],[54,'階段下'],[56,'到着'],['18,34','左斜め']]
    });

    /********************
     * room の決定
     ********************/
    const room = new URLSearchParams(location.search).get('room') || '3';

    /********************
     * HUD
     ********************/
    const hudMsg = document.getElementById('hudMsg');
    const hudAction = document.getElementById('hudAction');

    /********************
     * 距離データ（既存）
     ********************/
    const distRaw = {
      '3': { 11: 8, 12: 18, 13: 26, 14: 27, 15: 32, 16: 50, 17: 66, 23: 26, 24: 32, 25: 56, 26: 64 },
  '4': { 11: 7, 12: 21, 13: 29, 14: 29, 15: 33, 16: 48, 17: 63, 23: 27, 24: 32, 25: 53, 26: 61 },
  '5': { 11: 7, 12: 20, 13: 29, 14: 27, 15: 29, 16: 43, 17: 58, 23: 24, 24: 28, 25: 48, 26: 56 },
  '6': { 11: 21, 12: 26, 13: 33, 14: 28, 15: 26, 16: 32, 17: 44, 23: 25, 24: 23, 25: 34, 26: 41 },
  '7': { 11: 26, 12: 29, 13: 36, 14: 31, 15: 27, 16: 29, 17: 40, 23: 27, 24: 24, 25: 31, 26: 37 },
  '8': { 11: 26, 12: 29, 13: 35, 14: 29, 15: 25, 16: 27, 17: 38, 23: 26, 24: 22, 25: 29, 26: 35 },

  '9':  { 41: 8, 42: 25, 43: 32, 44: 39, 45: 47, 46: 48, 47: 24, 48: 18, 49: 10 },
  '10': { 41: 2, 42: 14, 43: 22, 44: 28, 45: 37, 46: 37, 47: 14, 48: 8, 49: 3 },
  '11': { 11:79,12:71,13:69,14:59,15:50,16:74,17:92,23:61,24:52,25:78,26:96,41: 0, 42: 30, 43: 50, 44: 67, 45: 72, 46: 78, 47: 31, 48: 20, 49: 4 },

  'gakumu': { 41: 21, 42: 6, 43: 4, 44: 10, 45: 18, 46: 19, 47: 8, 48: 14, 49: 21 },

  'free': { 11: 54, 12: 53, 13: 57, 14: 50, 15: 43, 16: 28, 17: 23, 23: 47, 24: 39, 25: 21, 26: 19 },

      '1': {}, '2': {}, '12': {}, '13': {},
      'exp1': {}, 'exp2': {}, 'exp4': {},
      'arch': {}, 'iotlab': {}
    };

    function pickMsg(room, value) {
      const table = distRaw[room];
      if (!table) return null;
      const d = table[value];
      if (d == null) return null;
      if (d === 0) return "到着しました";
      return `あと${d}m`;
    }

    function updateMsgHUD(room, value) {
      const text = pickMsg(room, value);
      if (!text) {
        hudMsg.style.display = 'none';
        hudMsg.textContent = '';
        return;
      }
      hudMsg.textContent = text;
      hudMsg.style.display = 'block';
    }

    function pickAction(room, value) {
      const dir = (plan[room] || {})[value];
      if (!dir) return null;
      if (dir === '階段上' || dir === '階段') return '階段を上がってください';
      if (dir === '階段下') return '階段を下りてください';
      if (dir === '到着') return '到着しました';
      return null;
    }

    function showUnregisteredIfNeeded() {
      const hasPlan = plan[room] && Object.keys(plan[room]).length > 0;
      if (hasPlan) return;
      hudMsg.style.display = 'none';
      hudMsg.textContent = '';
      hudAction.textContent = 'この目的地はルート未登録です';
      hudAction.style.display = 'block';
    }

    function updateActionHUD(room, value) {
      const text = pickAction(room, value);
      if (!text) return;

      hudMsg.style.display = 'none';
      hudMsg.textContent = '';

      hudAction.textContent = text;
      hudAction.style.display = 'block';
    }

    let activeActionMarker = null;
    let actionHideTimer = null;

    /********************
     * マーカー生成
     ********************/
    const scene = document.querySelector('a-scene');
    scene.addEventListener('loaded', () => {
      showUnregisteredIfNeeded();

      for (let v = 1; v <= MAX_MARKER; v++) {
        const marker = document.createElement('a-marker');
        marker.setAttribute('type', 'barcode');
        marker.setAttribute('value', String(v));
        marker.setAttribute('id', `m${v}`);

        // ===== GLB矢印（直進以外に使う） =====
        const arrowWrap = document.createElement('a-entity');
        arrowWrap.setAttribute('id', `arrowWrap-${v}`);

        const arrowYaw = document.createElement('a-entity');
        arrowYaw.setAttribute('id', `arrowYaw-${v}`);

        const arrow = document.createElement('a-entity');
        arrow.setAttribute('gltf-model', '#arrowModel');
        arrow.setAttribute('fit-model-height', `target: ${ARROW_TARGET_H}`);

        arrowYaw.appendChild(arrow);
        arrowWrap.appendChild(arrowYaw);

        // ===== 直進用：プリミティブ矢印 =====
        const fwdWrap = document.createElement('a-entity');
        fwdWrap.setAttribute('id', `fwdWrap-${v}`);
        fwdWrap.setAttribute('visible', false);
        fwdWrap.setAttribute('position', `${FORWARD_POS.x} ${FORWARD_POS.y} ${FORWARD_POS.z}`);
        fwdWrap.setAttribute('face-camera-yaw', 'offset: 0');

        const fwdTilt = document.createElement('a-entity');
        fwdTilt.setAttribute('rotation', `-35 0 0`);

        const cone = document.createElement('a-cone');
        cone.setAttribute('radius-bottom', '0.18');
        cone.setAttribute('radius-top', '0.0');
        cone.setAttribute('height', '0.35');
        cone.setAttribute('material', `color: ${FORWARD_COLOR}; metalness: 0.2; roughness: 0.35;`);
        cone.setAttribute('position', '0 0.20 0');

        const cyl = document.createElement('a-cylinder');
        cyl.setAttribute('radius', '0.07');
        cyl.setAttribute('height', '0.45');
        cyl.setAttribute('material', `color: ${FORWARD_COLOR}; metalness: 0.2; roughness: 0.35;`);
        cyl.setAttribute('position', '0 0 0');

        fwdTilt.appendChild(cyl);
        fwdTilt.appendChild(cone);
        fwdWrap.appendChild(fwdTilt);

        marker.appendChild(arrowWrap);
        marker.appendChild(fwdWrap);
        scene.appendChild(marker);

        marker.addEventListener('markerFound', () => {
          // 黒い棒掃除（arrowWrap と fwdWrap だけ残す）
          const keepA = `arrowWrap-${v}`;
          const keepB = `fwdWrap-${v}`;
          const kids = Array.from(marker.children);
          for (const child of kids) {
            if (child.id !== keepA && child.id !== keepB) marker.removeChild(child);
          }

          if (actionHideTimer) { clearTimeout(actionHideTimer); actionHideTimer = null; }

          apply(v);
          updateMsgHUD(room, v);

          const a = pickAction(room, v);
          if (a) {
            updateActionHUD(room, v);
            activeActionMarker = v;
          } else {
            // ルート未登録なら常時表示
            showUnregisteredIfNeeded();
            if (hudAction.textContent !== 'この目的地はルート未登録です') {
              hudAction.style.display = 'none';
              hudAction.textContent = '';
            }
            activeActionMarker = null;
          }
        });

        marker.addEventListener('markerLost', () => {
          if (activeActionMarker !== v) return;

          if (actionHideTimer) clearTimeout(actionHideTimer);
          actionHideTimer = setTimeout(() => {
            hudAction.style.display = 'none';
            hudAction.textContent = '';
            activeActionMarker = null;
            actionHideTimer = null;
          }, 600);
        });
      }

      apply();
    });

    /********************
     * 表示適用
     ********************/
    function apply(foundValue) {
      const table = plan[room] || {};
      const loopFrom = (foundValue ? foundValue : 1);
      const loopTo   = (foundValue ? foundValue : MAX_MARKER);

      for (let v = loopFrom; v <= loopTo; v++) {
        const dir = table[v];

        const arrowWrap = document.getElementById(`arrowWrap-${v}`);
        const arrowYaw  = document.getElementById(`arrowYaw-${v}`);
        const fwdWrap   = document.getElementById(`fwdWrap-${v}`);

        if (arrowWrap) arrowWrap.setAttribute('visible', false);
        if (fwdWrap)   fwdWrap.setAttribute('visible', false);

        if (arrowWrap) arrowWrap.setAttribute('position', `${POS_DEFAULT.x} ${POS_DEFAULT.y} ${POS_DEFAULT.z}`);
        if (arrowYaw)  arrowYaw.setAttribute('rotation', `0 0 0`);

        if (!dir) continue;

        if (dir === '階段' || dir === '階段上' || dir === '階段下' || dir === '到着') continue;

        const key = normDir(dir);

        // ★直進だけプリミティブ矢印
        if (key === 'forward') {
          if (fwdWrap) {
            fwdWrap.setAttribute('visible', true);
            fwdWrap.setAttribute('position', `${FORWARD_POS.x} ${FORWARD_POS.y} ${FORWARD_POS.z}`);
          }
          continue;
        }

        // ★それ以外：GLB矢印（変な反転はしない）
        if (arrowWrap) arrowWrap.setAttribute('visible', true);

        const p = POS_MAP[key] || POS_DEFAULT;
        if (arrowWrap) arrowWrap.setAttribute('position', `${p.x} ${p.y} ${p.z}`);

        const baseYaw = yawMap[key];
        if (typeof baseYaw === 'number') {
          const yaw = ((baseYaw + ARROW_YAW_OFFSET) % 360 + 360) % 360;
          if (arrowYaw) arrowYaw.setAttribute('rotation', `0 ${yaw} 0`);
        }
      }
    }
  </script>
</body>
</html>
