<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Navi (stairs=PNG)</title>
  <style>
    body{margin:0; overflow:hidden;}
    /* 右下メッセージHUD（必要なら使ってね） */
    #hudMsg{
      position: fixed; right: 12px; bottom: 12px; z-index: 9999;
      background:#111c; color:#fff; padding:10px 12px; border:1px solid #333;
      border-radius:12px; font-size:14px; line-height:1.5;
      max-width:min(60vw,320px); backdrop-filter: blur(6px);
      display:none; word-break: break-word;
    }
  </style>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
</head>
<body>

  <a-scene
    embedded
    renderer="colorManagement: true;"
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false"
  >
    <a-assets timeout="15000">
      <!-- 矢印・到着はGLBのまま -->
      <a-asset-item id="arrowModel"   src="arrow.glb"></a-asset-item>
      <a-asset-item id="arrivalModel" src="arrival.glb"></a-asset-item>

      <!-- ★ 階段PNG（スペース有りのファイル名対応） -->
      <img id="img-stairs-up"   src="up stairs.png">
      <img id="img-stairs-down" src="down stairs.png">
      <!-- 読み込めない場合はファイル名を up_stairs.png / down_stairs.png に変えるか %20 エンコードを使う -->
    </a-assets>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="hudMsg" aria-live="polite"></div>

<script>
/********************
 * 表示パラメータ
 ********************/
const ARROW_TARGET_H   = 0.45;   // 矢印GLBの見かけ高さ(m)
const ARRIVAL_TARGET_H = 0.60;   // 到着GLBの見かけ高さ(m)
const PNG_Y_POS        = 1.15;   // PNG(階段札)の高さ
const MARKER_MAX       = 58;     // マーカー数

/********************
 * 補助コンポーネント
 ********************/
// 看板のようにY軸のみカメラ正対
AFRAME.registerComponent('face-camera-yaw', {
  tick() {
    const cam = this.el.sceneEl && this.el.sceneEl.camera;
    if (!cam) return;
    const pos = new THREE.Vector3();
    this.el.object3D.getWorldPosition(pos);
    const dx = cam.position.x - pos.x;
    const dz = cam.position.z - pos.z;
    const yaw = Math.atan2(dx, dz) * 180 / Math.PI;
    this.el.setAttribute('rotation', `0 ${yaw} 0`);
  }
});

// 画像/文字を常に手前に
AFRAME.registerComponent('always-on-top', {
  init(){ this.el.object3D.traverse(o=>{
    if (o.material){ o.material.depthTest = false; o.renderOrder = 9999; }
  });}
});

// 距離に応じてスケール（見やすさキープ）
AFRAME.registerComponent('scale-by-distance', {
  schema: { k:{type:'number',default:0.18}, min:{type:'number',default:0.8}, max:{type:'number',default:2.2} },
  tick(){
    const cam = this.el.sceneEl && this.el.sceneEl.camera; if(!cam) return;
    const p = new THREE.Vector3(), c = new THREE.Vector3();
    this.el.object3D.getWorldPosition(p); cam.getWorldPosition(c);
    const d = p.distanceTo(c);
    const s = THREE.MathUtils.clamp(this.data.k * d, this.data.min, this.data.max);
    this.el.setAttribute('scale', `${s} ${s} ${s}`);
  }
});

// GLBの全高を指定値に合わせる
AFRAME.registerComponent('fit-model-height', {
  schema: { target: { type: 'number', default: 0.6 } },
  init() {
    this.el.addEventListener('model-loaded', () => {
      const obj = this.el.getObject3D('mesh'); if (!obj) return;
      obj.updateMatrixWorld(true);
      const box = new THREE.Box3().setFromObject(obj);
      const size = new THREE.Vector3(); box.getSize(size);
      const h = size.y || 1;
      const s = this.data.target / h;
      this.el.setAttribute('scale', `${s} ${s} ${s}`);
    });
  }
});

/********************
 * 矢印の向き
 ********************/
const ARROW_YAW_OFFSET = -90;
const yawMap = {
  '直進': 0, 'うしろ': 180, '下': 180,
  '右': -90, '左': 90,
  '右斜め': -45, '左斜め': 45,
  // 英語互換
  'up': 0, 'down': 180, 'back': 180, 'right': -90, 'left': 90
};

/********************
 * （任意）まとめ書きサポート
 ********************/
function expandKeys(keys){
  if (Array.isArray(keys)) return keys.flatMap(k=>expandKeys(k));
  if (typeof keys==='number') return [keys];
  return String(keys).split(',').flatMap(part=>{
    const s = part.trim();
    if (/^\d+-\d+$/.test(s)){
      const [a,b] = s.split('-').map(Number);
      const lo=Math.min(a,b), hi=Math.max(a,b);
      return Array.from({length:hi-lo+1},(_,i)=>lo+i);
    }
    return [Number(s)];
  });
}
function buildPlan(spec){
  const out={};
  for (const [room, entries] of Object.entries(spec)){
    const table = out[room]={};
    for (const [keys, dir] of entries){
      for (const v of expandKeys(keys)) table[v]=dir;
    }
  }
  return out;
}

/********************
 * ★ plan をここに定義
 * 例はダミー。あなたの内容に置き換えてOK
 ********************/
const plan = buildPlan({
  '10': [
    ['1-4','右'], ['5-6','階段上'], ['7-8','右'],
    [9,'階段上'], ['10-11','左'], [12,'左'], [13,'左'], [14,'左'],
    [15,'下'], [16,'右'], [17,'到着']
  ],
  // ほかの room も同様に…
});

/********************
 * room 決定
 ********************/
const room = new URLSearchParams(location.search).get('room') || '10';

/********************
 * マーカー生成（1..MARKER_MAX）
 * ここで階段PNGノードを仕込む
 ********************/
const scene = document.querySelector('a-scene');
scene.addEventListener('loaded', () => {
  for (let v=1; v<=MARKER_MAX; v++){
    const marker = document.createElement('a-marker');
    marker.setAttribute('type','barcode');
    marker.setAttribute('value', String(v));
    marker.setAttribute('id', `m${v}`);

    // 矢印（GLB）
    const arrowWrap = document.createElement('a-entity');
    arrowWrap.setAttribute('id', `arrowWrap-${v}`);
    const arrowYaw = document.createElement('a-entity');
    arrowYaw.setAttribute('id', `arrowYaw-${v}`);
    const arrow = document.createElement('a-entity');
    arrow.setAttribute('gltf-model', '#arrowModel');
    arrow.setAttribute('fit-model-height', `target: ${ARROW_TARGET_H}`);
    arrowYaw.appendChild(arrow);
    arrowWrap.appendChild(arrowYaw);

    // ★ 階段PNG（上り・下り）——GLBは使わない
    const stairsPNG = document.createElement('a-entity');
    stairsPNG.setAttribute('id', `stairsPNG-${v}`);
    stairsPNG.setAttribute('position', `0 ${PNG_Y_POS} 0`);
    stairsPNG.setAttribute('face-camera-yaw','');
    stairsPNG.setAttribute('scale-by-distance','k:0.18; min:0.8; max:2.0');
    stairsPNG.setAttribute('always-on-top','');

    const stairsUpImg = document.createElement('a-image');
    stairsUpImg.setAttribute('id', `stairsUpImg-${v}`);
    stairsUpImg.setAttribute('src', '#img-stairs-up');  // up stairs.png
    stairsUpImg.setAttribute('width','1.2');
    stairsUpImg.setAttribute('height','0.42');
    stairsUpImg.setAttribute('side','double');
    stairsUpImg.setAttribute('transparent','true');
    stairsPNG.appendChild(stairsUpImg);

    const stairsDownImg = document.createElement('a-image');
    stairsDownImg.setAttribute('id', `stairsDownImg-${v}`);
    stairsDownImg.setAttribute('src', '#img-stairs-down'); // down stairs.png
    stairsDownImg.setAttribute('width','1.2');
    stairsDownImg.setAttribute('height','0.42');
    stairsDownImg.setAttribute('side','double');
    stairsDownImg.setAttribute('transparent','true');
    stairsPNG.appendChild(stairsDownImg);

    // 到着（GLB）
    const arrivalGroup = document.createElement('a-entity');
    arrivalGroup.setAttribute('id', `arrivalGroup-${v}`);
    arrivalGroup.setAttribute('position', `0 1.2 0`);
    arrivalGroup.setAttribute('face-camera-yaw','');
    const arrival = document.createElement('a-entity');
    arrival.setAttribute('id', `arrival-${v}`);
    arrival.setAttribute('gltf-model', '#arrivalModel');
    arrival.setAttribute('fit-model-height', `target: ${ARRIVAL_TARGET_H}`);
    arrivalGroup.appendChild(arrival);

    // マーカーへ
    marker.appendChild(arrowWrap);
    marker.appendChild(stairsPNG);
    marker.appendChild(arrivalGroup);
    scene.appendChild(marker);

    marker.addEventListener('markerFound', () => {
      apply(v);
      // 右下メッセージを使ってるならここで updateMsgHUD(room, v) など
    });
  }
  apply();
});

/********************
 * 表示適用
 ********************/
function apply(foundValue){
  const table = plan[room] || {};
  const from = foundValue ? foundValue : 1;
  const to   = foundValue ? foundValue : MARKER_MAX;

  for (let v=from; v<=to; v++){
    const dir = table[v];

    const arrowWrap     = document.getElementById(`arrowWrap-${v}`);
    const arrowYaw      = document.getElementById(`arrowYaw-${v}`);
    const stairsPNG     = document.getElementById(`stairsPNG-${v}`);
    const stairsUpImg   = document.getElementById(`stairsUpImg-${v}`);
    const stairsDownImg = document.getElementById(`stairsDownImg-${v}`);
    const arrivalGroup  = document.getElementById(`arrivalGroup-${v}`);

    // 全部いったん非表示
    if (arrowWrap)    arrowWrap.setAttribute('visible', false);
    if (stairsPNG)    stairsPNG.setAttribute('visible', false);
    if (stairsUpImg)  stairsUpImg.setAttribute('visible', false);
    if (stairsDownImg)stairsDownImg.setAttribute('visible', false);
    if (arrivalGroup) arrivalGroup.setAttribute('visible', false);

    if (!dir) continue;

    // ★ PNG階段
    if (dir === '階段' || dir === '階段上' || dir === '階段下'){
      if (stairsPNG) stairsPNG.setAttribute('visible', true);
      if (dir === '階段下'){
        if (stairsDownImg) stairsDownImg.setAttribute('visible', true);
      } else {
        // '階段' は上り扱い
        if (stairsUpImg) stairsUpImg.setAttribute('visible', true);
      }
      continue;
    }

    // 到着（GLB）
    if (dir === '到着'){
      if (arrivalGroup) arrivalGroup.setAttribute('visible', true);
      continue;
    }

    // 矢印（GLB）
    const baseYaw = yawMap[dir];
    if (typeof baseYaw === 'number'){
      const yaw = ((baseYaw + ARROW_YAW_OFFSET) % 360 + 360) % 360;
      if (arrowWrap) arrowWrap.setAttribute('visible', true);
      if (arrowYaw)  arrowYaw.setAttribute('rotation', `0 ${yaw} 0`);
    }
  }
}

/********************
 * （任意）右下メッセージ用（そのまま流用可）
 ********************/
const MSG_HINT = { /* ここに room→value→{msg:"..."} を書けば右下に出せる */ };
const hudMsg = document.getElementById('hudMsg');
function pickMsg(room, value){
  if (MSG_HINT[room] && MSG_HINT[room][value]) return MSG_HINT[room][value].msg;
  if (MSG_HINT.default && MSG_HINT.default[value]) return MSG_HINT.default[value].msg;
  return null;
}
function updateMsgHUD(room, value){
  const text = pickMsg(room, value);
  if (!text){ hudMsg.style.display='none'; hudMsg.textContent=''; return; }
  hudMsg.textContent = text; hudMsg.style.display='block';
}
</script>
</body>
</html>
