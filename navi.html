<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Navi</title>
  <style>body{margin:0; overflow:hidden;}</style>
  <script src="aframe.min.js"></script>
  <script src="aframe-ar.js"></script>
</head>
<body>

  <!-- ===== A-Frame / AR.js シーン ===== -->
  <a-scene
    embedded
    renderer="colorManagement: true;"
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false"
  >

    <!-- 3Dアセットを先読み -->
    <a-assets timeout="15000">
      <a-asset-item id="arrowModel"   src="arrow.glb"></a-asset-item>
      <a-asset-item id="upStairsModel"   src="up stairs.glb"></a-asset-item>
      <a-asset-item id="downStairsModel" src="down stairs.glb"></a-asset-item>
      <!-- ★ 追加：到着GLB -->
      <a-asset-item id="arrivalModel" src="arrival.glb"></a-asset-item>
    </a-assets>

    <!-- カメラ -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    /********************
     * 表示パラメータ
     ********************/
    const ARROW_TARGET_H   = 0.45; // 矢印の見かけ高さ(m)
    const STAIRS_TARGET_H  = 0.60; // 階段の見かけ高さ(m)
    const ARRIVAL_TARGET_H = 0.60; // 到着表示の見かけ高さ(m) ← 追加
    const ARROW_YAW_OFFSET = -90;  // 矢印GLBの前向き補正（モデルに合わせて調整）
    const STAIRS_GROUP_POS = { x:0, y:0.8, z:0 }; // 階段看板の位置
    const ARRIVAL_GROUP_POS= { x:0, y:0.8, z:0 }; // 到着看板の位置 ← 追加

    /********************
     * 自作コンポーネント
     ********************/
    // GLBの全高を指定値に合わせる（モデルのバウンディングから自動スケール）
    AFRAME.registerComponent('fit-model-height', {
      schema: { target: { type: 'number', default: 0.6 } },
      init() {
        this.el.addEventListener('model-loaded', () => {
          const obj = this.el.getObject3D('mesh');
          if (!obj) return;
          obj.updateMatrixWorld(true);
          const box = new THREE.Box3().setFromObject(obj);
          const size = new THREE.Vector3(); box.getSize(size);
          const h = size.y || 1;
          const s = this.data.target / h;
          this.el.setAttribute('scale', `${s} ${s} ${s}`);
        });
      }
    });

    // 看板のようにY軸だけカメラへ正対させる（上下の傾きは追従しない）
    AFRAME.registerComponent('face-camera-yaw', {
      tick() {
        const cam = this.el.sceneEl && this.el.sceneEl.camera;
        if (!cam) return;
        const wp = new THREE.Vector3();
        this.el.object3D.getWorldPosition(wp);
        const dx = cam.position.x - wp.x;
        const dz = cam.position.z - wp.z;
        const yaw = Math.atan2(dx, dz) * 180 / Math.PI;
        this.el.setAttribute('rotation', `0 ${yaw} 0`);
      }
    });

    /********************
     * 向きマップ（矢印系）
     ********************/
    const yawMap = {
      '直進': 0, 'うしろ': 180, '下': 180,
      '右': -90, '左': 90,
      '右斜め': -45, '左斜め': 45,
      // 互換
      'up': 0, 'down': 180, 'back': 180,
      'right': -90, 'left': 90
    };

    /********************
     * 経路テーブル（例）
     * plan[room][markerValue] = 指示
     * 指示：『右/左/直進/うしろ/右斜め/左斜め/階段上/階段下/到着』
     ********************/
    const plan = {
 '3':  {1:'右', 2:'到着',3:'到着', 4:'左',5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左',12:'階段下',13:'左',14:'右',15:'階段下',16:'右',17:'右',18:'右'},
      '4':  {1:'右', 2:'右', 3:'下', 4:'直進', 5:'到着',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左',12:'階段下',13:'左',14:'右',15:'階段下',16:'右',17:'右',18:'右'},
      '5':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'直進', 6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左',12:'階段下',13:'左',14:'右',15:'階段下',16:'右',17:'右',18:'右'},
      '6':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'ひだり', 8:'左斜め', 9:'左',10:'左',11:'左',12:'階段下',13:'左',14:'右',15:'階段下',16:'右',17:'右',18:'右'},
      '7':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'右',   7:'直進',   8:'左斜め', 9:'左',10:'左',11:'左',12:'階段下',13:'左',14:'右',15:'階段下',16:'右',17:'右',18:'右'},
      '8':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'うしろ', 8:'左斜め', 9:'左',10:'左',11:'左',12:'階段下',13:'左',14:'右',15:'階段下',16:'右',17:'右',18:'右'},
      '9':  {1:'右', 2:'右', 3:'下', 4:'右', 5:'右', 6:'階段上', 7:'右', 8:'下', 9:'階段上', 10:'左',11:'左'},
      '10': {1:'右',2:'右',3:'右',4:'右', 5:'階段上',6:'階段上', 7:'右',8:'右', 9:'階段上', 10:'左',11:'左',
             12:'左',13:'左', 14:'左', 15:'下', 16:'右',17:'右'},
      '11': {1:'右',2:'右',3:'右',4:'右', 5:'階段上',6:'階段上', 7:'右',8:'右', 9:'階段上', 10:'左',11:'左',
             12:'左',13:'左',14:'左',15:'左',16:'左', 17:'下'},
      'gakumu': {1:'右',2:'右',3:'右',4:'右', 5:'階段上',6:'階段上', 7:'右',8:'右', 9:'階段上', 10:'左',11:'左',
                 12:'下',13:'下', 14:'右',15:'右',16:'右',17:'右'}
    };

    /********************
     * room の決定
     ********************/
    const room = new URLSearchParams(location.search).get('room') || '3';

    /********************
     * マーカーの生成（1..28）
     ********************/
    const scene = document.querySelector('a-scene');
    scene.addEventListener('loaded', () => {
      // 28個のマーカーをまとめて作る
      for (let v = 1; v <= 28; v++) {
        const marker = document.createElement('a-marker');
        marker.setAttribute('type', 'barcode');
        marker.setAttribute('value', String(v));
        marker.setAttribute('id', `m${v}`);

        // --- 矢印ノード ---
        // arrowWrap … 位置/上下の調整
        //  └ arrowYaw … Y回転だけ当てる（GLBはこの子に付ける）
        const arrowWrap = document.createElement('a-entity');
        arrowWrap.setAttribute('id', `arrowWrap-${v}`);
        const arrowYaw = document.createElement('a-entity');
        arrowYaw.setAttribute('id', `arrowYaw-${v}`);
        const arrow = document.createElement('a-entity');
        arrow.setAttribute('gltf-model', '#arrowModel');
        arrow.setAttribute('fit-model-height', `target: ${ARROW_TARGET_H}`);
        arrowYaw.appendChild(arrow);
        arrowWrap.appendChild(arrowYaw);

        // --- 階段ノード（UP/DOWNをまとめる） ---
        const stairsGroup = document.createElement('a-entity');
        stairsGroup.setAttribute('id', `stairsGroup-${v}`);
        stairsGroup.setAttribute('position', `${STAIRS_GROUP_POS.x} ${STAIRS_GROUP_POS.y} ${STAIRS_GROUP_POS.z}`);
        // UP
        const stairsUp = document.createElement('a-entity');
        stairsUp.setAttribute('id', `stairsUp-${v}`);
        stairsUp.setAttribute('gltf-model', '#upStairsModel');
        stairsUp.setAttribute('fit-model-height', `target: ${STAIRS_TARGET_H}`);
        stairsUp.setAttribute('face-camera-yaw', '');
        // DOWN
        const stairsDown = document.createElement('a-entity');
        stairsDown.setAttribute('id', `stairsDown-${v}`);
        stairsDown.setAttribute('gltf-model', '#downStairsModel');
        stairsDown.setAttribute('fit-model-height', `target: ${STAIRS_TARGET_H}`);
        stairsDown.setAttribute('face-camera-yaw', '');
        stairsGroup.appendChild(stairsUp);
        stairsGroup.appendChild(stairsDown);

        // --- ★ 到着ノード（看板表示） ---
        const arrivalGroup = document.createElement('a-entity');
        arrivalGroup.setAttribute('id', `arrivalGroup-${v}`);
        arrivalGroup.setAttribute('position', `${ARRIVAL_GROUP_POS.x} ${ARRIVAL_GROUP_POS.y} ${ARRIVAL_GROUP_POS.z}`);
        arrivalGroup.setAttribute('face-camera-yaw', '');
        const arrival = document.createElement('a-entity');
        arrival.setAttribute('id', `arrival-${v}`);
        arrival.setAttribute('gltf-model', '#arrivalModel');
        arrival.setAttribute('fit-model-height', `target: ${ARRIVAL_TARGET_H}`);
        arrivalGroup.appendChild(arrival);

        // マーカーに全部ぶら下げる
        marker.appendChild(arrowWrap);
        marker.appendChild(stairsGroup);
        marker.appendChild(arrivalGroup);
        scene.appendChild(marker);

        // 検出/見失いイベントで反映
        marker.addEventListener('markerFound', () => apply(v));
        marker.addEventListener('markerLost',  () => { /* 必要なら非表示など */ });
      }

      // 初期反映（開いた直後に一度）
      apply();
    });

    /********************
     * 表示適用
     * plan[room][value] に応じて
     *  - 矢印の向き
     *  - 階段（UP/DOWN）
     *  - ★ 到着表示
     * を切り替える
     ********************/
    function apply(foundValue) {
      const table = plan[room] || {};
      // 1..28 すべて（foundValueがあればそこだけでもOK）
      const loopFrom = (foundValue ? foundValue : 1);
      const loopTo   = (foundValue ? foundValue : 28);

      for (let v = loopFrom; v <= loopTo; v++) {
        const dir = table[v];

        const arrowWrap   = document.getElementById(`arrowWrap-${v}`);
        const arrowYaw    = document.getElementById(`arrowYaw-${v}`);
        const stairsGroup = document.getElementById(`stairsGroup-${v}`);
        const stairsUp    = document.getElementById(`stairsUp-${v}`);
        const stairsDown  = document.getElementById(`stairsDown-${v}`);
        const arrivalGroup= document.getElementById(`arrivalGroup-${v}`);

        // デフォルトは全部非表示 → 指示に応じて必要なものだけ表示
        if (arrowWrap)    arrowWrap.setAttribute('visible', false);
        if (stairsGroup)  stairsGroup.setAttribute('visible', false);
        if (stairsUp)     stairsUp.setAttribute('visible', false);
        if (stairsDown)   stairsDown.setAttribute('visible', false);
        if (arrivalGroup) arrivalGroup.setAttribute('visible', false);

        if (!dir) continue; // 指示なしは何も出さない

        // 1) 階段（上/下）
        if (dir === '階段' || dir === '階段上' || dir === '階段下') {
          stairsGroup.setAttribute('visible', true);
          if (dir === '階段下') {
            stairsDown.setAttribute('visible', true);
          } else {
            stairsUp.setAttribute('visible', true); // '階段' は上り扱い
          }
          continue;
        }

        // 2) ★ 到着
        if (dir === '到着') {
          arrivalGroup.setAttribute('visible', true);
          continue;
        }

        // 3) 矢印（右/左/直進/うしろ/斜め…）
        const baseYaw = yawMap[dir];
        if (typeof baseYaw === 'number') {
          const yaw = ((baseYaw + ARROW_YAW_OFFSET) % 360 + 360) % 360;
          arrowWrap.setAttribute('visible', true);
          arrowYaw.setAttribute('rotation', `0 ${yaw} 0`);
        }
      }
    }
  </script>
</body>
</html>
