<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR Navi (矢印GLB＋階段GLB)</title>

  <!-- A-Frame / AR.js（CDN） -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <script>
    // 階段モデルを「正面に読みやすく」見せる：カメラのヨー（Y軸）だけ合わせる
    AFRAME.registerComponent('face-camera-yaw', {
      init(){ this.vCam=new THREE.Vector3(); this.vObj=new THREE.Vector3(); },
      tick(){
        const s=this.el.sceneEl; if(!s||!s.camera) return;
        s.camera.getWorldPosition(this.vCam);
        this.el.object3D.getWorldPosition(this.vObj);
        const dx=this.vCam.x-this.vObj.x, dz=this.vCam.z-this.vObj.z;
        const yaw=Math.atan2(dx,dz);               // +Math.PI は入れない（鏡像防止）
        this.el.object3D.rotation.set(0,yaw,0);    // ピッチ/ロールは固定
      }
    });
  </script>
</head>
<body style="margin:0; overflow:hidden;">

  <a-scene id="scene"
           embedded
           renderer="alpha: true; antialias: true"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: true"
           arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; debugUIEnabled: false">
    <!-- アセット（矢印GLB / 階段GLB） -->
    <a-assets timeout="20000" id="assets">
      <a-asset-item id="arrowModel"  src="arrow.glb"></a-asset-item>
      <a-asset-item id="stairsModel" src="stairs.glb"></a-asset-item>
    </a-assets>

    <a-entity camera id="cam"></a-entity>

    <!-- マーカー群は動的にここへ -->
    <a-entity id="markerLayer" visible="true"></a-entity>
  </a-scene>

  <script>
    /* ======= 矢印の向きテーブル（従来どおり） ======= */
    const yawMap = {'直進':0,'下':0,'うしろ':180,'右':-90,'左':90,'右斜め':-45,'左斜め':45};
    const normalize = d => d==='ひだり' ? '左' : d;

    /* ======= 目的地ごとの指示（そのまま） ======= */
    const plan = {
      '3':  {1:'右', 2:'うしろ',3:'うしろ', 4:'左',5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '4':  {1:'右', 2:'右', 3:'下', 4:'直進', 5:'左',6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '5':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'直進', 6:'左',7:'左', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '6':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'ひだり', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '7':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'右',   7:'直進',   8:'左斜め', 9:'左',10:'左',11:'左'},
      '8':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'直進', 7:'うしろ', 8:'左斜め', 9:'左',10:'左',11:'左'},
      '9':  {1:'右', 2:'右', 3:'下', 4:'右',   5:'右',   6:'階段', 7:'右',     8:'下',     9:'階段', 10:'左',11:'左'},
      '10': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
             12:'左',13:'左', 14:'左', 15:'下', 16:'右',17:'右'},
      '11': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
             12:'左',13:'左',14:'左',15:'左',16:'左', 17:'下'},
      'gakumu': {1:'右',2:'右',3:'右',4:'右', 5:'階段',6:'階段', 7:'右',8:'右', 9:'階段', 10:'左',11:'左',
                 12:'下',13:'下', 14:'右',15:'右',16:'右',17:'右'}
    };

    /* ======= モデルの基準調整 =======
       - 矢印GLB：モデルの“前”が A-Frame の -Z を向くように見える回転
       - 階段GLB：看板/アイコンの見栄えに合わせて調整
       必要に応じて下の値を微調整してください。 */
    const ARROW_MODEL_BASE_ROT  = '0 0 0';     // 例: 矢印の前が -Z を向くなら 0 0 0
    const ARROW_MODEL_SCALE     = '0.7 0.7 0.7';
    const ARROW_MODEL_POS       = '0 0 0';     // 高さを上げたい場合は '0 0.3 0' 等に

    const STAIRS_MODEL_BASE_ROT = '0 0 0';     // 例: 正面が -Z を向く向きに合わせる
    const STAIRS_MODEL_SCALE    = '1.8 1.8 1.8';
    const STAIRS_GROUP_POS      = '0 1.2 0.35';// 少し上 & マーカー面より手前(+Z)

    const room = new URLSearchParams(location.search).get('room') || '3';

    const scene = document.getElementById('scene');
    scene.addEventListener('loaded', () => {
      const layer = document.getElementById('markerLayer');

      for (let i = 1; i <= 28; i++) {
        const marker = document.createElement('a-marker');
        marker.setAttribute('type','barcode');
        marker.setAttribute('value', String(i));
        marker.setAttribute('id', `marker-${i}`);

        /* ===== 矢印（arrow.glb） ===== */
        const arrowWrap = document.createElement('a-entity');
        arrowWrap.setAttribute('id', `arrowWrap${i}`);
        arrowWrap.setAttribute('visible','true');

        // 矢印のヨー回転ノード（ここだけ回す）
        const arrowYaw = document.createElement('a-entity');
        arrowYaw.setAttribute('id', `arrowYaw${i}`);
        arrowYaw.setAttribute('rotation','0 0 0');

        // 矢印モデル本体
        const arrowModel = document.createElement('a-entity');
        arrowModel.setAttribute('gltf-model', '#arrowModel');
        arrowModel.setAttribute('rotation', ARROW_MODEL_BASE_ROT);
        arrowModel.setAttribute('scale', ARROW_MODEL_SCALE);
        arrowModel.setAttribute('position', ARROW_MODEL_POS);

        arrowYaw.appendChild(arrowModel);
        arrowWrap.appendChild(arrowYaw);

        /* ===== 階段（stairs.glb） =====
           - 文字の代わりにGLBを表示
           - カメラのヨーだけ追従して読みやすく */
        const stairsGroup = document.createElement('a-entity');
        stairsGroup.setAttribute('id', `stairsGroup${i}`);
        stairsGroup.setAttribute('visible','false');
        stairsGroup.setAttribute('face-camera-yaw','');
        stairsGroup.setAttribute('position', STAIRS_GROUP_POS);

        // 見た目微調整用の子ノード（回転・スケールはここに）
        const stairsModelNode = document.createElement('a-entity');
        stairsModelNode.setAttribute('rotation', STAIRS_MODEL_BASE_ROT);
        stairsModelNode.setAttribute('scale',    STAIRS_MODEL_SCALE);

        const stairsModel = document.createElement('a-entity');
        stairsModel.setAttribute('gltf-model', '#stairsModel');

        stairsModelNode.appendChild(stairsModel);
        stairsGroup.appendChild(stairsModelNode);

        // ツリーへ追加
        marker.appendChild(arrowWrap);
        marker.appendChild(stairsGroup);
        layer.appendChild(marker);

        /* ===== 指示を反映 ===== */
        const apply = () => {
          const dirRaw = (plan[room] || {})[i];
          if (!dirRaw) return;
          const dir = normalize(dirRaw);

          if (dir === '階段') {
            arrowWrap.setAttribute('visible','false');
            stairsGroup.setAttribute('visible','true');
          } else {
            stairsGroup.setAttribute('visible','false');
            arrowWrap.setAttribute('visible','true');
            const yaw = yawMap[dir] ?? 0;
            // GLBの「前」は -Z を想定。基準は ARROW_MODEL_BASE_ROT で合わせ済み。
            arrowYaw.setAttribute('rotation', `0 ${yaw} 0`);
          }
        };

        apply();
        marker.addEventListener('markerFound', apply);
      }
    });
  </script>
</body>
</html>
